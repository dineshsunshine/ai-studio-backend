# Look Videos Integration - Simplified API Guide

## Overview
Enhancement to link generated videos with looks using existing video API.

**Key Principle:** No new endpoints needed. Frontend passes `look_id` when creating videos.

## Simple Integration Flow

### Frontend Flow:
```
1. User generates video FOR a specific look
2. Frontend calls: POST /api/v1/video-jobs?look_id={lookId}
3. Backend automatically links the video to the look
4. Video appears in look details
```

### Standalone Videos (Unchanged):
```
1. User generates video independently  
2. Frontend calls: POST /api/v1/video-jobs (no look_id)
3. Video created without any look association
4. Works exactly as before
```

## API Integration

### Create Video (With or Without Look)

```
POST /api/v1/video-jobs
Content-Type: multipart/form-data
Authorization: Bearer <JWT_TOKEN>

Form Data:
- prompt: Optional text prompt
- model: Video model (e.g., 'veo-3.1-generate-preview')
- resolution: '720p' or '1080p'
- aspectRatio: '16:9' or '9:16'
- durationSeconds: 4 or 8
- generateAudio: Optional boolean (default: false)
- mockMode: 'true' or 'false' (REQUIRED)
- lookId: Optional UUID of look to link video to (NEW)

Response: 202 Accepted
{
  "id": "video-id-uuid",
  "status": "PENDING",
  "cloudinaryUrl": null,
  "createdAt": "2025-11-02T...",
  "progressPercentage": 0
}
```

### Example 1: Video for Specific Look

```javascript
// Frontend code
const formData = new FormData();
formData.append('prompt', 'Model wearing the dress');
formData.append('model', 'veo-3.1-generate-preview');
formData.append('resolution', '720p');
formData.append('aspectRatio', '16:9');
formData.append('durationSeconds', 8);
formData.append('generateAudio', false);
formData.append('mockMode', 'false');
formData.append('lookId', look.id);  // ← Link to specific look

const response = await fetch('/api/v1/video-jobs', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
```

### Example 2: Standalone Video (No Look Association)

```javascript
// Frontend code - same endpoint, just no lookId
const formData = new FormData();
formData.append('prompt', 'A sunset scene');
formData.append('model', 'veo-3.1-generate-preview');
formData.append('resolution', '720p');
formData.append('aspectRatio', '16:9');
formData.append('durationSeconds', 8);
formData.append('generateAudio', false);
formData.append('mockMode', 'false');
// No lookId - video created independently

const response = await fetch('/api/v1/video-jobs', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
```

## Backend Behavior

**If look_id is provided:**
1. Verify look exists
2. Verify current user owns the look
3. Create video job
4. Link video to look in `look_videos` table
5. Queue video generation

**If look_id is NOT provided:**
1. Create video job
2. Queue video generation
3. No look association

## Updated Look Response

Look responses include `videos` array (empty if no videos):

```json
{
  "id": "look-id",
  "title": "Stone Essence",
  "generatedImageUrl": "https://...",
  "products": [...],
  "visibility": "private",
  "videos": [
    {
      "id": "video-id-1",
      "status": "SUCCEEDED",
      "cloudinaryUrl": "https://res.cloudinary.com/...",
      "isDefault": true,
      "createdAt": "2025-11-02T...",
      "progressPercentage": 100
    }
  ],
  "createdAt": "...",
  "updatedAt": "..."
}
```

## Permission Logic

**Backend validates:**
- look_id exists in database
- current_user.id === look.user_id
- Returns 400 Bad Request if validation fails

**Frontend can:**
- Only pass look_id for looks they own
- Omit look_id for standalone videos
- Always works for any authenticated user

## Video Status Handling

Same as existing video API:
- PENDING: Video is being generated
- RUNNING: Video generation in progress
- SUCCEEDED: Video ready (cloudinaryUrl populated)
- FAILED: Video generation failed

## Token Consumption

- 50 tokens per video job creation
- Same whether linked to look or standalone
- Charged on job creation, not completion

## Concurrent Job Limit

- Max 3 concurrent jobs per user
- Same limit for all videos (look-linked or standalone)
- 429 Too Many Requests if exceeded

## Error Codes

| Status | Error | Scenario |
|--------|-------|----------|
| 400 | "Invalid look_id" | Look not found or user doesn't own it |
| 402 | "Insufficient tokens" | User out of tokens |
| 429 | "Maximum 3 concurrent..." | Too many pending/running jobs |

## Database Migration

One-time setup (required once):
```
POST /api/v1/migrate/look-videos
Authorization: Bearer <ADMIN_TOKEN>
```

Creates `look_videos` junction table for linking.

## Key Implementation Points

1. **Optional Parameter**: look_id is completely optional
2. **User Validation**: Backend validates user owns the look
3. **Backward Compatible**: Existing video flow unchanged
4. **Same Endpoint**: No new endpoints to manage
5. **Simple for Frontend**: Just add lookId to form data

## Testing

### Local Testing with Swagger:
1. Open http://localhost:8000/docs
2. Find POST /api/v1/video-jobs endpoint
3. Fill in parameters
4. Add lookId in form data to link to look
5. Submit and monitor status

### Production Testing:
1. https://ai-studio-backend-ijkp.onrender.com/docs
2. Same workflow as local

## Why This Approach?

✅ **No new endpoints** - reuse existing video API
✅ **Simpler for frontend** - just add one parameter
✅ **Backward compatible** - existing video flow unchanged
✅ **Flexible** - can create videos standalone or linked
✅ **Easy to implement** - minimal changes needed

## Support

- Check video job status: GET /api/v1/video-jobs/{videoId}
- Check look details: GET /api/v1/looks/{lookId}
- Video logs available in job response

